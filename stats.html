<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#121212">
    <link rel="manifest" href="manifest.json">
    <title>GymLog - Statystyki</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'neon-green': '#10b981',
                        'dark-bg': '#121212',
                        'dark-card': '#1e1e1e',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-bg text-gray-100 min-h-screen pb-20">
    <div class="max-w-lg mx-auto p-4 sm:p-6">
        <!-- Header -->
        <header class="flex items-center justify-between mb-8 pt-4">
            <div class="flex items-center gap-3">
                <img src="logo.png" alt="GymLog" class="h-10 w-auto">
            </div>
            <div class="flex items-center gap-2">
                <button 
                    id="exportBtn"
                    class="p-2.5 text-gray-500 hover:text-neon-green transition-colors bg-dark-card rounded-lg"
                    title="Eksportuj do CSV"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="space-y-8">
            <!-- Top 3 Exercises -->
            <section>
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-6 h-6 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <h2 class="text-xl font-black text-gray-300">Top 3 Ä†wiczenia</h2>
                </div>
                <div id="topExercises" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </section>

            <!-- Personal Records -->
            <section>
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-6 h-6 text-neon-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    <h2 class="text-xl font-black text-gray-300">Rekordy Å»yciowe (PR)</h2>
                </div>
                <div id="personalRecords" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </section>

            <!-- Progress Charts -->
            <section>
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                    </svg>
                    <h2 class="text-xl font-black text-gray-300">Wykresy PostÄ™pu</h2>
                </div>
                <div id="charts" class="space-y-6">
                    <!-- Populated by JS -->
                </div>
            </section>
        </main>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-dark-card border-t border-gray-800 z-50">
        <div class="max-w-lg mx-auto flex">
            <a href="index.html" class="flex-1 flex flex-col items-center justify-center py-4 text-gray-500 hover:text-gray-400 transition-colors">
                <svg class="w-7 h-7 mb-1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C10.9 2 10 2.9 10 4C10 5.1 10.9 6 12 6C13.1 6 14 5.1 14 4C14 2.9 13.1 2 12 2M16.5 9.5C15.67 9.5 15 10.17 15 11C15 11.83 15.67 12.5 16.5 12.5S18 11.83 18 11 17.33 9.5 16.5 9.5M7.5 9.5C6.67 9.5 6 10.17 6 11S6.67 12.5 7.5 12.5 9 11.83 9 11 8.33 9.5 7.5 9.5M14.97 11.5C14.87 10.87 14.5 10.29 14 9.83C13.5 9.38 12.78 9 12 9C11.22 9 10.5 9.38 10 9.83C9.5 10.29 9.13 10.87 9.03 11.5H7.5C7.5 11.5 6 11 6 13.5V17C6 17.5 6.45 18 7 18C7.55 18 8 17.5 8 17V14H9V21C9 21.5 9.45 22 10 22C10.55 22 11 21.5 11 21V15H13V21C13 21.5 13.45 22 14 22C14.55 22 15 21.5 15 21V14H16V17C16 17.5 16.45 18 17 18C17.55 18 18 17.5 18 17V13.5C18 11 16.5 11.5 16.5 11.5H14.97Z"/>
                </svg>
                <span class="text-xs font-bold">TRENING</span>
            </a>
            <a href="stats.html" class="flex-1 flex flex-col items-center justify-center py-4 text-neon-green">
                <svg class="w-7 h-7 mb-1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <span class="text-xs font-bold">STATYSTYKI</span>
            </a>
        </div>
    </nav>
    
    <!-- Update notification -->
    <div id="updateNotification" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-neon-green text-dark-bg px-6 py-4 rounded-2xl font-bold shadow-2xl z-50 max-w-sm animate-slide-in">
        <div class="flex items-center gap-3">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            <div class="flex-1">
                <p class="text-sm">DostÄ™pna aktualizacja!</p>
                <p class="text-xs opacity-80">Kliknij aby odÅ›wieÅ¼yÄ‡</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="app.js"></script>
    <script>
        // Register Service Worker with update checking
        if ('serviceWorker' in navigator) {
            let refreshing = false;
            
            // NasÅ‚uchuj zmian kontrolera (nowy SW przejÄ…Å‚ kontrolÄ™)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                refreshing = true;
                window.location.reload();
            });
            
            navigator.serviceWorker.register('/sw.js')
                .then(reg => {
                    console.log('Service Worker registered');
                    
                    // SprawdÅº aktualizacje co 60 sekund
                    setInterval(() => {
                        reg.update();
                    }, 60000);
                    
                    // SprawdÅº aktualizacjÄ™ przy starcie
                    reg.update();
                    
                    // NasÅ‚uchuj na nowego Service Worker czekajÄ…cego
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // Nowa wersja dostÄ™pna
                                showUpdateNotification();
                            }
                        });
                    });
                })
                .catch(err => console.error('Service Worker error', err));
            
            // NasÅ‚uchuj wiadomoÅ›ci od Service Worker
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data.type === 'VERSION') {
                    console.log('Current Service Worker version:', event.data.version);
                }
            });
        }
        
        function showUpdateNotification() {
            const notification = document.getElementById('updateNotification');
            notification.classList.remove('hidden');
            
            notification.onclick = () => {
                // Powiadom czekajÄ…cego SW aby przejÄ…Å‚ kontrolÄ™
                navigator.serviceWorker.getRegistration().then(reg => {
                    if (reg.waiting) {
                        reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }
                });
            };
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            displayTopExercises();
            displayPersonalRecords();
            displayCharts();
            
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
        });

        // Display top 3 exercises
        function displayTopExercises() {
            const topExercises = getTopExercises();
            const container = document.getElementById('topExercises');
            
            if (topExercises.length === 0) {
                container.innerHTML = `
                    <div class="bg-dark-card border-2 border-dashed border-gray-800 rounded-2xl p-8 text-center">
                        <p class="text-gray-600 font-medium">Brak danych</p>
                    </div>
                `;
                return;
            }
            
            const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
            
            container.innerHTML = topExercises.map((ex, i) => `
                <div class="bg-dark-card border border-gray-800 rounded-xl p-4 flex items-center justify-between hover:border-gray-700 transition-colors">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">${medals[i]}</span>
                        <div>
                            <p class="font-bold text-lg">${ex.name}</p>
                            <p class="text-xs text-gray-500">${ex.count} ${ex.count === 1 ? 'seria' : 'serii'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-neon-green font-black text-sm">${ex.totalVolume.toFixed(0)}</p>
                        <p class="text-xs text-gray-600">objÄ™toÅ›Ä‡</p>
                    </div>
                </div>
            `).join('');
        }

        // Display personal records with share button
        function displayPersonalRecords() {
            const records = getPersonalRecords();
            const container = document.getElementById('personalRecords');
            
            if (records.length === 0) {
                container.innerHTML = `
                    <div class="bg-dark-card border-2 border-dashed border-gray-800 rounded-2xl p-8 text-center">
                        <p class="text-gray-600 font-medium">Brak rekordÃ³w</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = records.map(record => `
                <div class="bg-dark-card border border-gray-800 rounded-xl p-4 flex items-center justify-between hover:border-gray-700 transition-colors">
                    <div>
                        <p class="font-bold text-lg">${record.exercise}</p>
                        <p class="text-xs text-gray-500">${new Date(record.date).toLocaleDateString('pl-PL')}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-2 bg-gray-900 px-4 py-2 rounded-lg">
                            <span class="text-neon-green font-black text-2xl">${record.weight}</span>
                            <span class="text-gray-600 text-xs font-bold">kg</span>
                            <span class="text-gray-700 mx-1">Ã—</span>
                            <span class="text-white font-black text-lg">${record.reps}</span>
                        </div>
                        <button 
                            class="p-2 text-gray-500 hover:text-neon-green transition-colors"
                            onclick="shareRecord('${record.exercise}', ${record.weight}, ${record.reps})"
                            title="UdostÄ™pnij rekord"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Display charts for top 3 exercises
        function displayCharts() {
            const grouped = groupSetsByExercise();
            const exercises = Object.keys(grouped);
            const container = document.getElementById('charts');
            
            if (exercises.length === 0) {
                container.innerHTML = `
                    <div class="bg-dark-card border-2 border-dashed border-gray-800 rounded-2xl p-8 text-center">
                        <p class="text-gray-600 font-medium">Brak danych do wyÅ›wietlenia</p>
                    </div>
                `;
                return;
            }
            
            // Top 3 exercises by count
            const topExercises = exercises
                .map(name => ({ name, count: grouped[name].length }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 3);
            
            container.innerHTML = topExercises
                .filter(({ name }) => grouped[name].length >= 2)
                .map(({ name }) => {
                    const chartId = `chart-${name.replace(/\s+/g, '-').replace(/[()]/g, '')}`;
                    return `
                        <div class="bg-dark-card border border-gray-800 rounded-xl p-5">
                            <h3 class="font-bold text-lg mb-4 text-neon-green">${name}</h3>
                            <div class="bg-gray-900 rounded-lg p-3">
                                <canvas id="${chartId}"></canvas>
                            </div>
                        </div>
                    `;
                }).join('');
            
            // If no charts to display
            if (container.innerHTML === '') {
                container.innerHTML = `
                    <div class="bg-dark-card border-2 border-dashed border-gray-800 rounded-2xl p-8 text-center">
                        <p class="text-gray-600 font-medium">Potrzebujesz co najmniej 2 treningi dla kaÅ¼dego Ä‡wiczenia</p>
                    </div>
                `;
                return;
            }
            
            // Create charts
            topExercises.forEach(({ name }) => {
                const sets = grouped[name].slice().reverse(); // Oldest to newest
                const chartId = `chart-${name.replace(/\s+/g, '-').replace(/[()]/g, '')}`;
                const ctx = document.getElementById(chartId);
                
                if (ctx && sets.length >= 2) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: sets.map((_, i) => `#${i + 1}`),
                            datasets: [
                                {
                                    label: 'CiÄ™Å¼ar (kg)',
                                    data: sets.map(s => s.weight),
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    borderWidth: 3,
                                    tension: 0.3,
                                    fill: true,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            aspectRatio: 2,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(30, 30, 30, 0.95)',
                                    titleColor: '#10b981',
                                    bodyColor: '#fff',
                                    borderColor: '#10b981',
                                    borderWidth: 1,
                                    padding: 12,
                                    displayColors: false,
                                    callbacks: {
                                        title: (items) => {
                                            const index = items[0].dataIndex;
                                            const date = new Date(sets[index].timestamp);
                                            return date.toLocaleString('pl-PL', { 
                                                day: '2-digit', 
                                                month: '2-digit',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            });
                                        },
                                        label: (context) => {
                                            const set = sets[context.dataIndex];
                                            return `${set.weight}kg Ã— ${set.reps} powtÃ³rzeÅ„`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { color: 'rgba(75, 85, 99, 0.3)' },
                                    ticks: { color: '#6b7280', font: { size: 10 } }
                                },
                                y: {
                                    grid: { color: 'rgba(75, 85, 99, 0.3)' },
                                    ticks: { 
                                        color: '#10b981', 
                                        font: { size: 11, weight: 'bold' },
                                        callback: (value) => value + ' kg'
                                    }
                                }
                            },
                            interaction: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    });
                }
            });
        }
    </script>
</body>
</html>
